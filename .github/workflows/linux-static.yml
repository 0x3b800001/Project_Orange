name: Linux Static

on:
  push:
    paths-ignore: ["README.md", "LICENSE", "BUILD.md"]
  pull_request:
    paths-ignore: ["README.md", "LICENSE", "BUILD.md"]
  release:
    types: [published]

jobs:
  check_commit_msg:
    outputs:
      commit_message: ${{ steps.get_message.outputs.message }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Get commit message
        id: get_message
        run: |
          echo "message=$(git log --format=%B -n 1 ${{ github.event.after }})" >> $GITHUB_OUTPUT

  linux:
    strategy:
      fail-fast: false
      matrix:
        build_type: [Release, RelWithDebInfo]
    needs: check_commit_msg
    if: ${{ !contains(needs.check_commit_msg.outputs.commit_message, 'NO_DEB') }}
    name: Linux Static ${{ matrix.build_type }}
    runs-on: ubuntu-latest
    container: ubuntu:20.04
    env:
      CCACHE_DIR: ${{ github.workspace }}/.ccache
      TZ: Asia/Shanghai
      DEBIAN_FRONTEND: noninteractive
      QT_DIR: ${{ github.workspace }}/qt
    
    steps:
      # 第一步：安装基础工具 (包括 wget!)
      - name: Install base tools
        run: |
          apt-get update
          DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends \
            git wget ca-certificates  # 必须包含 wget
          rm -rf /var/lib/apt/lists/*

      - name: Get the version
        id: get_version
        shell: bash
        run: echo "VERSION=$(echo $GITHUB_REF | cut -d / -f 3)" >> $GITHUB_OUTPUT

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: "recursive"

      # 第二步：安装构建依赖 (包含所有开发库)
      - name: Install build dependencies
        run: |
          apt-get update
          DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends \
            build-essential ninja-build cmake pkgconf bash \
            libgl1-mesa-dev libglu1-mesa-dev \
            libfontconfig1-dev libfreetype6-dev libx11-dev libx11-xcb-dev libxext-dev \
            libxfixes-dev libxi-dev libxrender-dev libxcb1-dev libxcb-glx0-dev \
            libxcb-keysyms1-dev libxcb-image0-dev libxcb-shm0-dev libxcb-icccm4-dev \
            libxcb-sync0-dev libxcb-xfixes0-dev libxcb-shape0-dev libxcb-randr0-dev \
            libxcb-render-util0-dev libxcb-xinerama0-dev libxkbcommon-dev \
            libxkbcommon-x11-dev libharfbuzz-dev libsm-dev libdrm-dev libspdlog-dev
          rm -rf /var/lib/apt/lists/*

      # 第三步：安装 Qt (使用 wget 下载)
      - name: Install Qt
        run: |
          mkdir -p $QT_DIR
          wget -q https://github.com/Project-LemonLime/qt5ci/releases/latest/download/qt-5.15.3-kde-static-linux.tar.gz -O /tmp/qt.tar.gz
          tar xzf /tmp/qt.tar.gz -C $QT_DIR --strip-components=1
          rm /tmp/qt.tar.gz  # 清理临时文件

      # 第四步：构建 (使用绝对路径)
      - name: Build
        run: |
          mkdir ${{ github.workspace }}/build
          cd ${{ github.workspace }}/build
          cmake ${{ github.workspace }}/Project_LemonLime \
            -GNinja \
            -DCMAKE_BUILD_TYPE=${{ matrix.build_type }} \
            -DLEMON_BUILD_INFO="Build for Linux" \
            -DLEMON_BUILD_EXTRA_INFO="Build on $(uname -sr)" \
            -DCMAKE_PREFIX_PATH=$QT_DIR
          cmake --build . --target package --parallel $(nproc)
          cp lemon ${{ github.workspace }}/Project_LemonLime/

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: LemonLime-linux-x86_64-${{ matrix.build_type }}
          path: ${{ github.workspace }}/Project_LemonLime/lemon

      - name: Upload binaries to release
        uses: svenstaro/upload-release-action@v2
        if: startsWith(github.ref, 'refs/tags/')
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          file: ${{ github.workspace }}/Project_LemonLime/lemon
          asset_name: LemonLime-linux-x86_64-${{ matrix.build_type }}
          tag: ${{ github.ref }}
          overwrite: true